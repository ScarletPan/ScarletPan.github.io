---
layout: post
title: Steps for starting a django app
tags: python
comments: false
modifed: 2016-08-24
---

### Tips1: &emsp; 配置 pymysql　*
在　__init__.py 中添加：

``` python
import pymysql
pymysql.install_as_MySQLdb()
```

在　setting.py中修改：

``` python
DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.mysql',
        'NAME': 'vqa',  # mysql数据库名
        'USER':'root',  #　mysql用户名，留空则默认为当前linux用户名　
        'PASSWORD':'123456',
        'HOST':'',     # 留空默认为localhost
        'PORT':'',     # 留空默认为3306端口
    }
}
```

### Tips2: &emsp; 创建数据库并且migrate
在 mysql  中创建数据库
在项目目录中输入

```
$ python manage.py migrate
```

成功后会看到：

```
Operations to perform:
  Apply all migrations: auth, sessions, admin, contenttypes
Running migrations:
  Rendering model states... DONE
  Applying contenttypes.0001_initial... OK
  Applying auth.0001_initial... OK
  Applying admin.0001_initial... OK
  Applying admin.0002_logentry_remove_auto_add... OK
  Applying contenttypes.0002_remove_content_type_name... OK
  Applying auth.0002_alter_permission_name_max_length... OK
  Applying auth.0003_alter_user_email_max_length... OK
  Applying auth.0004_alter_user_username_opts... OK
  Applying auth.0005_alter_user_last_login_null... OK
  Applying auth.0006_require_contenttypes_0002... OK
  Applying auth.0007_alter_validators_add_error_messages... OK
  Applying sessions.0001_initial... OK

```

### Tips3: &emsp; 创建app
在项目目录中输入

```
$ python manage.py startapp polls
```

### Tips4: &emsp; 创建模型
编辑　app/models.py

### Tips5: &emsp; 激活模型
编辑　project/settings/py

``` python
INSTALLED_APPS = (
    'django.contrib.admin',
    'django.contrib.auth',
    'django.contrib.contenttypes',
    'django.contrib.sessions',
    'django.contrib.messages',
    'django.contrib.staticfiles',
    'app',    # 这是新增的app
)
```

运行命令

```
$ python manage.py makemigrations app    # app迁移
$ python manage.py sqlmigrate vqa 0001　 # sql迁移
$ python manage.py migrate # 将这些改变更新到数据库中。
```

### Tips5(+): &emsp; 修改模型

```
$ 修改models.py （最好每个类中都写上 def __str__())
$ python manage.py makemigrations
$ python manage.py migrate
```

### Tips6: &emsp; 创建管理网站

```
$ python manage.py createsuperuser # 创建一个能够登录管理站点的用户
```

在admin.py中注册，添加

``` python
from django.contrib import admin

from .models import xxx

admin.site.register(xxx)
```

### Tips7: &emsp; 制作对外view
* html 模板
在app中创建 app/templates/app/xxx.html
* css,js, images 模板,
1. 在app中创建 app/static/css/xxx.css
2. 在project/setting.py 找到 STATIC_URL 并在下方添加

```
STATIC_ROOT = os.path.join(os.path.dirname(__file__),'static')
STATICFILES_DIRS = (
    ('css',os.path.join(STATIC_ROOT,'css').replace('\\','/') ), 
    ('js',os.path.join(STATIC_ROOT,'js').replace('\\','/') ),
    ('images',os.path.join(STATIC_ROOT,'images').replace('\\','/') ),
)
```

并创建相应的文件。
3. 相应的html中的link改为：

```html
    <link type="text/css" rel="stylesheet" href="/static/css/xxx.css" />
```

### Tips8: &emsp; 部署项目
详见：http://djangobook.py3k.cn/2.0/chapter12/



###  *ImageField 的使用
1. 在setting.py中添加路径和url:

```
MEDIA_ROOT = BASE_DIR + 'xxx/media/'
MEDIA_URL =  BASE_URL + 'xxx/media/'   # 两者其实相同
```

2. 在project/urls.py添加 url:

``` python
from django.conf.urls.static import static
from django.conf import settings
***
urlpatterns += static(settings.MEDIA_URL, document_root=settings.MEDIA_ROOT)
```

3. 在app/model.py中对于相应的model:

```
xxx = models.ImageField(upload_to = '***') # ***为相对路径
```

### *配置ajax
在js脚本前添加配置：

```javascript
function getCookie(name) {
    var cookieValue = null;
    if (document.cookie && document.cookie != '') {
        var cookies = document.cookie.split(';');
        for (var i = 0; i < cookies.length; i++) {
            var cookie = jQuery.trim(cookies[i]);
            // Does this cookie string begin with the name we want?
            if (cookie.substring(0, name.length + 1) == (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
var csrftoken = getCookie('csrftoken');
function csrfSafeMethod(method) {
    // these HTTP methods do not require CSRF protection
    return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
}
function sameOrigin(url) {
    // test that a given url is a same-origin URL
    // url could be relative or scheme relative or absolute
    var host = document.location.host; // host + port
    var protocol = document.location.protocol;
    var sr_origin = '//' + host;
    var origin = protocol + sr_origin;
    // Allow absolute or scheme relative URLs to same origin
    return (url == origin || url.slice(0, origin.length + 1) == origin + '/') ||
        (url == sr_origin || url.slice(0, sr_origin.length + 1) == sr_origin + '/') ||
        // or any other URL that isn't scheme relative or absolute i.e relative.
        !(/^(\/\/|http:|https:).*/.test(url));
}
$.ajaxSetup({
    beforeSend: function(xhr, settings) {
        if (!csrfSafeMethod(settings.type) && sameOrigin(settings.url)) {
            // Send the token to same-origin, relative URLs only.
            // Send the token only if the method warrants CSRF protection
            // Using the CSRFToken value acquired earlier
            xhr.setRequestHeader("X-CSRFToken", csrftoken);
        }
    }
});
```

