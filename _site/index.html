<!doctype html>
<!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"> <![endif]-->
<!--[if (IE 7)&!(IEMobile)]><html class="no-js lt-ie9 lt-ie8" lang="en"><![endif]-->
<!--[if (IE 8)&!(IEMobile)]><html class="no-js lt-ie9" lang="en"><![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"><!--<![endif]-->
<head>
<meta charset="utf-8">
<title>Latest Posts &#8211; My SCARLET</title>
<meta name="description" content="Describe this nonsense.">
<meta name="keywords" content="Jekyll, theme, themes, responsive, blog, modern">



<!-- Open Graph -->
<meta property="og:locale" content="en_US">
<meta property="og:type" content="article">
<meta property="og:title" content="Latest Posts">
<meta property="og:description" content="Describe this nonsense.">
<meta property="og:url" content="/">
<meta property="og:site_name" content="My SCARLET">





<link rel="canonical" href="/">
<link href="/feed.xml" type="application/atom+xml" rel="alternate" title="My SCARLET Feed">

<!-- http://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">
<!-- Webfonts -->
<link href="//fonts.googleapis.com/css?family=Lato:300,400,700,300italic,400italic" rel="stylesheet" type="text/css">

<meta http-equiv="cleartype" content="on">

<!-- Load Modernizr -->
<script src="/assets/js/vendor/modernizr-2.6.2.custom.min.js"></script>

<!-- Icons -->
<!-- 16x16 -->
<link rel="shortcut icon" href="/favicon.ico">
<!-- 32x32 -->
<link rel="shortcut icon" href="/favicon.png">
<!-- 57x57 (precomposed) for iPhone 3GS, pre-2011 iPod Touch and older Android devices -->
<link rel="apple-touch-icon-precomposed" href="/images/apple-touch-icon-precomposed.png">
<!-- 72x72 (precomposed) for 1st generation iPad, iPad 2 and iPad mini -->
<link rel="apple-touch-icon-precomposed" sizes="72x72" href="/images/apple-touch-icon-72x72-precomposed.png">
<!-- 114x114 (precomposed) for iPhone 4, 4S, 5 and post-2011 iPod Touch -->
<link rel="apple-touch-icon-precomposed" sizes="114x114" href="/images/apple-touch-icon-114x114-precomposed.png">
<!-- 144x144 (precomposed) for iPad 3rd and 4th generation -->
<link rel="apple-touch-icon-precomposed" sizes="144x144" href="/images/apple-touch-icon-144x144-precomposed.png">



</head>

<body id="post-index" class="feature">

<!--[if lt IE 9]><div class="upgrade"><strong><a href="http://whatbrowser.org/">Your browser is quite old!</strong> Why not upgrade to a different browser to better enjoy this site?</a></div><![endif]-->
<nav id="dl-menu" class="dl-menuwrapper" role="navigation">
	<button class="dl-trigger">Open Menu</button>
	<ul class="dl-menu">
		<li><a href="/">Home</a></li>
		<li>
			<a href="#">About</a>
			<ul class="dl-submenu">
				<li>
					<img src="/images/author.jpg" alt="Haojie PAN photo" class="author-photo">
					<h4>Haojie PAN</h4>
					<p>I wish I could.</p>
				</li>
				<li><a href="/about/"><span class="btn btn-inverse">Learn More</span></a></li>
				<li>
					<a href="mailto:3140102237@zju.edu.cn"><i class="fa fa-fw fa-envelope"></i> Email</a>
				</li>
				
				
				
				
				<li>
					<a href="https://github.com/ScarletPan"><i class="fa fa-fw fa-github"></i> GitHub</a>
				</li>
				
				
				
				
			</ul><!-- /.dl-submenu -->
		</li>
		<li>
			<a href="#">Posts</a>
			<ul class="dl-submenu">
				<li><a href="/posts/">All Posts</a></li>
				<li><a href="/tags/">All Tags</a></li>
			</ul>
		</li>
		
	</ul><!-- /.dl-menu -->
</nav><!-- /.dl-menuwrapper -->


<div class="entry-header">
  <div class="image-credit">Image source: <a href="http://www.dargadgetz.com/ios-7-abstract-wallpaper-pack-for-iphone-5-and-ipod-touch-retina/">dargadgetz</a></div><!-- /.image-credit -->
  
    <div class="entry-image">
      <img src="/images/abstract-4.jpg" alt="Latest Posts">
    </div><!-- /.entry-image -->
  
  <div class="header-title">
    <div class="header-title-wrap">
      <h1>My SCARLET</h1>
      <h2>Latest Posts</h2>
    </div><!-- /.header-title-wrap -->
  </div><!-- /.header-title -->
</div><!-- /.entry-header -->

<div id="main" role="main">
  
<article class="hentry">
  <header>
    
    <div class="entry-meta">
      <span class="entry-date date published updated"><time datetime="2017-04-28T00:00:00+00:00"><a href="/summary-of-get-a-silver-medal-in-kaggle/">April 28, 2017</a></time></span><span class="author vcard"><span class="fn"><a href="/about/" title="About Haojie PAN">Haojie PAN</a></span></span>
      
      <span class="entry-reading-time">
        <i class="fa fa-clock-o"></i>
        
Reading time ~1 minute
      </span><!-- /.entry-reading-time -->
      
    </div><!-- /.entry-meta -->
    
      <h1 class="entry-title"><a href="/summary-of-get-a-silver-medal-in-kaggle/" rel="bookmark" title="第一次参加Kaggle拿银总结" itemprop="url">第一次参加Kaggle拿银总结</a></h1>
    
  </header>
  <div class="entry-content">
    <blockquote>
<p>在这篇博客开始之前，我必须感谢@<a href="http://www.cad.zju.edu.cn/home/dengcai/">Prof. Cai</a>
给我提供服务器资源，@<a href="http://fenixlin.github.io">fenixlin</a>
学长从他自身经验出发耐心地为我解答一些困惑，素未谋面的@<a href="https://dnc1994.com">dnc1994</a>学长的一篇非常优秀的<a href="https://dnc1994.com/2016/04/rank-10-percent-in-first-kaggle-competition/">博文</a>帮助入门，
以及广大Kaggler的无私分享，我确实在Kaggle举行的这场<a href="https://www.kaggle.com/c/two-sigma-connect-rental-listing-inquiries">Rental Listing Inquiries</a>
比赛中收益良多，获得了不少知识。作为一个大三学生第一次参加，获得了Top 5%的成绩已经让我非常满意了。</p>
</blockquote>

<p><img src="../images/RLI-rank.png"/>
<p></p>
&emsp;&emsp;这篇文章的目的是介绍自己第一次参加Kaggle的心历路程，总结遇到的问题和解决思路，为自己以后参赛做准备。同时这篇文章也可以作为一个初学者的入门Kaggle的参考，如果想要在入门kaggle的时候拿到一个好的名次，可以参考我的一些方法实践。本文可以随意转载，但务必<strong>注明出处和作者</strong>, 并且发邮件(myscarlet@sina.com)通知与我。</p>

<h3>&emsp;目录</h3>

<ul>
<li><a href="#1">初识Kaggle</a></li>
<li><a href="#2">Step 1: 数据探索和可视化（EDA）</a></li>
<li><a href="#3">Step 2: 提取基础特征+模型训练</a></li>
<li><a href="#4">Step 3: 跑出一个能提交的结果</a></li>
<li><a href="#5">Step 4: 特征工程（FE）</a></li>
<li><a href="#6">Step 5: 模型调参（Grid Search）</a></li>
<li><a href="#7">Step 6: 模型融合</a></li>
<li><a href="#8">Tricks</a></li>
<li><a href="#9">总结</a></li>
</ul>

<p>&emsp;&emsp;</p>

<h3><h2 id="1"> 初识Kaggle </h2></h3>

<h4>什么是Kaggle</h4>

<p>&emsp;&emsp;从刚接触machine learning的时候就有在学长口中、博文中、社区中听到过它的名字，当初我对它的理解还比较浮浅，只是知道是一个数据比赛的平台，有很多公开的数据集，比如大二寒假做的第一个ML练手项目就是一个用word2vec进行情感分析的Tutorial级<a href="https://www.kaggle.com/c/word2vec-nlp-tutorial/data">比赛</a>，并且写了一个<a href="http://o6qr23o6z.bkt.clouddn.com/paper%20for%20sentiment%20analysis.pdf">research report</a>。就只用到了教程和数据集。
<p>&emsp;&emsp;后来重新接触Kaggle才发现，它的价值所在是各种高质量的比赛，以及每场比赛下面的社区讨论（包括比赛中的分享、答疑，和比赛后的top solution分享），因此如果想要获得关于数据挖掘，机器学习实战经验的话，打一场kaggle比赛绝对是一个高回报的工作。</p>
<p>&emsp;&emsp;因为还是学生，不知道kaggle比赛究竟是否会为自己求职工作有举足轻重的影响，但是单从Kaggle被google收购一点来看，它会在行业内一点点提升影响力的。</p></p>

<h4>比赛组织</h4>

<p>&emsp;&emsp;一场比赛通常持续2～3个月，在比赛的简介中会有规则、评价指标（比如这场比赛为mlogloss），时间轴等信息。另外还有数据区、Kernel区（一些Kagglers在kaggle上成功运行的ipython notebook或者代码），Discussion（讨论区），LeaderBoard（LB，分为公开的用户提交可以显示结果的榜单，和非公开的比赛结束后确定最终排名的榜单），当然还有提交区（一般为一定格式的csv文件提交）。
<p>&emsp;&emsp;另外就是奖牌问题，一般来讲在1000+量级的比赛中，top 10+ 0.2%为金牌，5%为银牌，10%为铜牌，<a href="https://www.kaggle.com/progression">这里</a>有更具体的奖牌发放方式。</p></p>

<h4>讨论区</h4>

<p>&emsp;&emsp;个人认为，如果想在入门Kaggle阶段就获得一个好的成绩的话，关注discussion是非常重要的，会有很多人分享自己的思路、困惑甚至代码和结果。有时候，一场比赛中比较关键的feature可能就是从讨论区中获得的，比如<a href="https://www.kaggle.com/c/two-sigma-connect-rental-listing-inquiries">Rental Listing Inquiries</a>这场比赛的最后几天，我以为自己特征提取得已经差不多了，没有任何idea了的时候，一个来自讨论区magic feature从天而降，从而使得榜单大变，一夜之间我的排名从70多掉到了120多。</p>

<h3><h2 id="2"> 数据探索和可视化（EDA） </h2></h3>

<p>&emsp;&emsp;首先拿到一个比赛题目，你需要下决心是否参加这个比赛，对我个人而言最重要的无非两点1. 是不是有rank point，也就是奖牌， 2. 数据集是否令我满意。 因此对数据的探索首先需要你从Kaggle网站上查看数据的简介，并把数据下载下来。比如<a href="https://www.kaggle.com/c/two-sigma-connect-rental-listing-inquiries">Rental Listing Inquiries</a>包含了80G的图片数据，和几份json文件。
<p>&emsp;&emsp;我们将下载下来的train.csv用python pandas 打开，取少量样本进行观测</p></p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">In</span> <span class="p">[</span><span class="mi">1</span><span class="p">]:</span> <span class="kn">import</span> <span class="nn">pandas</span> <span class="kn">as</span> <span class="nn">pd</span>
<span class="n">In</span> <span class="p">[</span><span class="mi">2</span><span class="p">]:</span> <span class="n">train</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_json</span><span class="p">(</span><span class="s">"input/train.json"</span><span class="p">)</span>
<span class="n">In</span> <span class="p">[</span><span class="mi">3</span><span class="p">]:</span> <span class="n">train</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</code></pre></div>
<p><img src="../images/kaggle_RLI_data1.png"/>
<p>
<img src="../images/kaggle_RLI_data2.png"/>
<p>&emsp;&emsp;抛开图片数据不谈，我们可以看到给定的数据里包含多种多样的feature：</p>

<ul>
<li>数值型feature

<ul>
<li>bathrooms</li>
<li>bedrooms</li>
<li>price</li>
</ul></li>
<li>高势集类别（High Categorical）型feature

<ul>
<li>building_id</li>
<li>display_address</li>
<li>manager_id</li>
<li>street_address</li>
</ul></li>
<li>时间型feature

<ul>
<li>created</li>
</ul></li>
<li>地理位置型feature

<ul>
<li>longitude</li>
<li>latitude</li>
</ul></li>
<li>文本feature

<ul>
<li>description</li>
</ul></li>
<li>稀疏特征集feature

<ul>
<li>features</li>
</ul></li>
<li>id型feature

<ul>
<li>listing_id</li>
<li>index</li>
</ul></li>
</ul>

<p>&emsp;&emsp;我们看到有这么多不同的feature，一看几乎每个feature都有深度挖掘的价值，何况还有80G的图片feature，无疑是让人兴奋的，因此我选择了这个比赛，因为它的数据集的确让我舒心。</p>

<p>&emsp;&emsp;另外一定要搞明白的一件事是这场比赛是一个预测比赛还是分类比赛，我们能看到最重要预测的是用户的interest_level，分为low，medium，high三级，很显然是个分类问题了。</p>

<p>&emsp;&emsp;接下来的是就是对数据进行可视化探索了，我因为是初期参赛的，所以自己做了一份可视化方案，从中可以发现很多有趣的分布、outlier等。在这里推荐三份在比赛中分享出来的比较好的EDA：</p>

<ul>
<li><a href="https://www.kaggle.com/sudalairajkumar/two-sigma-connect-rental-listing-inquiries/simple-exploration-notebook-2-connect">Simple Exploration Notebook</a></li>
<li><a href="https://www.kaggle.com/poonaml/two-sigma-connect-rental-listing-inquiries/two-sigma-renthop-eda">Two Sigma RentHop EDA</a></li>
<li><a href="https://www.kaggle.com/neviadomski/two-sigma-connect-rental-listing-inquiries/data-exploration-two-sigma-renthop">Data Exploration Two Sigma Renthop</a></li>
</ul>

<p>&emsp;&emsp;一般的比赛初期就会有人共享出他的数据可视化方案，因此如果是新手的话，初期不必浪费时间在这上面，因为从别人的kernel中就能发现很多东西了。</p>

<p>&emsp;&emsp;然而，需要强调的是，EDA的过程并不是在初期进行后以后都不做了，在以后的不断找新的feature的时候，EDA会给予你灵感。本人的一个关键feature就是在后期重新做了一些可视化后获得的。</p>

<h3><h2 id="3"> 提取基础特征+模型训练 </h2></h3>

<p>&emsp;&emsp;有了之前数据探索的基础，我们很快能提取到一些基础的feature，比如数值型feature进行简单的加减乘除，类别型feature用id顺序编码，稀疏特征集用one-hot编码，时间特征生成年、月、日等。将一些基础的特征转换成相应的输入input_X矩阵后，再将label也转换成数值形式：</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="ow">in</span> <span class="p">[</span><span class="mi">2</span><span class="p">]:</span> <span class="n">target_num_map</span> <span class="o">=</span> <span class="p">{</span><span class="s">'high'</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span> <span class="s">'medium'</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span> <span class="s">'low'</span><span class="p">:</span><span class="mi">2</span><span class="p">}</span>
<span class="ow">in</span> <span class="p">[</span><span class="mi">3</span><span class="p">]:</span> <span class="n">y</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">"interest_level"</span><span class="p">]</span><span class="o">.</span><span class="nb">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">target_num_map</span><span class="p">[</span><span class="n">x</span><span class="p">])</span>
</code></pre></div>
<p>&emsp;&emsp;懂机器学习的人都知道，有了这些(X，y)对，我们就可以进行模型训练了。</p>

<p>&emsp;&emsp;我们用cross-validation（CV）的成绩来判断我们本地的实验结果，也就是将（X，y）训练集拆分成训练和验证集，训练相应分类器对训练集拟合，再在验证集上进行loss的计算来评估模型的好坏。</p>

<p>&emsp;&emsp;常见的分类器有Logistic Classifier，SVM， NN softmax，Random Forest等。但是在kaggle上用的比较多的还是一些封装好的库，如sklearn里的各种分类器，大名鼎鼎的xgboost，最近崭露头角的lightgbm等。</p>

<p>&emsp;&emsp;早就听闻xgboost的好用，我就直接在电脑上pip了xgboost，作为我接下来一两个月以来的核心分类器。将原先的（X，y）对中的训练部分输入xgboost进行fit，然后用验证部分predict计算mlogloss。</p>

<p>&emsp;&emsp;至此为止，比赛初期的第一个模型就已经训练好了。</p>

<h3><h2 id="4"> 跑出一个能提交的结果 </h2></h3>

<p>&emsp;&emsp;训练完一个比较好的模型之后，就可以对测试集进行预测了，首先将训练集（X，y）对输入xgboost中重新训练，然后对测试集也像对训练集一样进行特征处理，预测出来的结果按照比赛指定的格式保存到文件（在这里还是建议用pandas），即可提交。</p>

<p>&emsp;&emsp;第一次提交意味着你正式进入比赛，提交的结果会在Leader Board上显示你当前的排名，当然这个排名只起到参考作用，因为你提交上去的大部分结果kaggle都没有进行评估。</p>

<h3><h2 id="5"> 特征工程（FE） </h2></h3>

<p>&emsp;&emsp;在一系列的初始操作以后，你就要踏上FE的漫漫长征了。本人断断续续在数据清洗、特征提取上做了约两个多月，在比赛最后一段时间模型融合完毕后还在继续地寻找、测试新的特征。后期评论区中magic feature的出现，让每个人的预测结果好了0.01～0.02个点。不得不说，特征工程才是Kaggle比赛获胜的关键所在，因此初学者耗费大量精力在这上面是没错的。而本博文也是重点想讲一下自己发现新特征的一些心历路程。
<p>&emsp;&emsp;在对一些基础的特征进行生成之后，我开始了漫长地测试特征的长征路，测试的思路我后来发现并不是很好，因为是通过新增加一个或几个feature，如果cv分数上去了，就增加这个feature，如果cv分数没有上去，就舍弃这个feature，也就是相当于贪心验证。这样做的弊处在于，如果之前被舍弃的feature和之后被舍弃的feature联合在一起才会有正面影响，就相当于你错过了两个比较好的feature。因此特征的选择和联合显得非常关键。</p>
<p>&emsp;&emsp;在比赛阶段，花费大量力气去创建一个feature，到头来却选择放弃这个feature的事情很常见，我后期的特征有很多是新添加的，旧有的一些特征并没有保留。接下来就让我总结一下这场比赛中有哪些“好”的feature，为以后的比赛提供灵感和经验。</p></p>

<ul>
<li><p><strong>数值型feature的简单加减乘除</strong>
<p>&emsp;&emsp;这个乍一看仿佛没有道理可言，但是事实上却能挖掘出几个feature之间的内在联系，比如这场比赛中提供了bathrooms和bedrooms的数量，以及价格price，合租用户可能会更关心每个卧室的价格，即<code>bathrooms / price</code>，也会关心是不是每个房间都会有一个卫生间<code>bathrooms / price</code>，这些数值型feature之间通过算数的手段建立了联系，从而挖掘出了feature内部的一些价值，分数也就相应地上去了。</p></p></li>
<li><p><strong>高势集类别</strong>（High Categorical）进行经验贝叶斯转换成数值feature
<p>&emsp;&emsp;什么是High Categorical的特征呢？一个简单的例子就是邮编，有100个城市就会有好几百个邮编，有些房子坐落在同一个邮编下面。很显然随着邮编的数量增多，如果用简单的one-hot编码显然效果不太好，因此有人就用一些统计学思想（经验贝叶斯）将这些类别数据进行一个map，得到的结果是数值数据。在这场比赛中有人分享了一篇<a href="http://helios.mm.di.uoa.gr/%7Erouvas/ssi/sigkdd/sigkdd.vol3.1/barreca.ps">paper</a>里面就提到了具体的算法。详细就不仔细讲了，用了这个encoding之后，的确效果提升了很多。那么这场比赛中哪些数据可以进行这样的encoding呢，只要满足下面几点：1. 会重复，2. 根据相同的值分组会分出超过一定数量（比如100）的组。也就是说building_id, manager_id, street_address, display_address都能进行这样的encoding，而取舍就由最后的实验来决定了。 </p></p></li>
<li><p><strong>时间特征</strong>
<p>&emsp;&emsp;针对于时间数据来讲，提取年、月、日、星期等可能还是不够的，有另外一些points可以去思考，用户的兴趣跟发布时间的久远是否有关系？可以构造如下的feature来进行测试：
<code>python
data[&quot;latest&quot;] = (data[&quot;created&quot;]- data[&quot;created&quot;].min())
</code>
<code>python
data[&quot;passed&quot;] = (data[&quot;created&quot;].max()- data[&quot;created&quot;])
</code>
<p>&emsp;&emsp;可以看到latest指的是从有数据开始到该房创建为止一共过去了多少时间，而passed则是该房记录创建为止到最后有记录的时候一共过去了多少时间。</p>
<p>&emsp;&emsp;另外针对于时间特征还可以用可视化的方式来与其他特征建立联系，比如我们观察listing_id与时间变化到底有怎样的联系，能够绘制出如下的图来：</p></p></li>
</ul>

<p><img src="../images/kaggle_RLI_data3.png"/></p>

<p>&emsp;&emsp; 可能简单的相除就能获得很好的结果</p>

<p></p></p>

<ul>
<li><p><strong>地理位置特征</strong>
<p>&emsp;&emsp;想到地理位置，就会想到聚类，一个简单的方式将每个房子划分到同一块区域中去；除了聚类以外，算出几个中心点坐标，计算曼哈顿距离或者欧式距离可能都会有神奇的效果。</p></p></li>
<li><p><strong>文本特征</strong>
<p>&emsp;&emsp;实话说自己是看中这次比赛中有文本数据才参加的，因此在文本挖掘中做了很大的努力，比如提取关键词、情感分析、word embedding聚类之类都尝试过，但效果都不是很好, 对于文本的特征的建议还是去找出一些除了停用词以外的高频词汇，寻找与这个房屋分类问题的具体联系。</p></p></li>
<li><p><strong>图片特征</strong>
<p>&emsp;&emsp;除了最后爆料出来的magic feature(后文会提到)以外，我只用了一个房子有几个照片这个信息。讨论区中都说对于图片特征用CNN提取、简单特征提取之类的效果都不是很好。</p></p></li>
<li><p><strong>稀疏特征集</strong>
<p>&emsp;&emsp;其实就相当于一系列标签，不同标签的个数也是挺多的，本次比赛我只是简单地采用了counterEncoding的方式进行one-hot编码。值得一提的是，有些标签是可以合并的，比如cat allowed 和 dog allowed可以合并成为 pet allowed，我在这场比赛中手工地合并了一些feature数据，最终结果略微有所提升。</p></p></li>
<li><p><strong>特征重要程度</strong>（feature importance）
<p>&emsp;&emsp;在树结构的分类器比如randomforest、xgboost中最后能够对每个特征在分类上面的重要程度进行一个评估。这时候如果已经选定了一些feature进行训练了之后，查看feature importance的反馈是非常重要的，比如本场比赛制胜的关键是运用manager_id这个feature，而它的feature importance反馈结果也是非常高。通过对重要特征的重新再提取特征，能够发现很多有意思的新特征，这才是用FE打好一场比赛的关键所在。</p></p></li>
</ul>

<p>&emsp;&emsp;下面列出了一些比赛结束后获胜者分享的idea，这大概是我这场比赛中获益最大的一块地方了。</p>

<ul>
<li>Top #1 <a href="https://www.kaggle.com/c/two-sigma-connect-rental-listing-inquiries/discussion/32163">solution</a> @plantsgo
<p> &emsp;&emsp;主要是针对manager_id生成了非常多的feature。如根据不同时间出现的manager_id判断一个manager是否活跃（manager与time进行group，manager掌管有几个不同的房子（manager与building_id进行group）、平均每天处理多少房子（比值）、活动范围（同个manager掌管的房子的最大最小经纬度group），经理的开价程度（选择bedroom和bathroom作为房子型号指标，把相同房型的均价来衡量经理对于所有房子的开价程度），对经纬度进行聚类再计算每个区域中有多少个manager竞争、一个manager同时经营几个区域、在同个区域中manager的开价水平等。从Top 1选手分享的代码来看，其对于manager的各种处理的确是让人大开眼界。</p></li>
<li>Top #2 <a href="https://www.kaggle.com/c/two-sigma-connect-rental-listing-inquiries/discussion/32148">solution</a> @Faron
<p> &emsp;&emsp;从更为经验老道的选手给出了一些特征提取建议。其中有一类被作者称为&quot;Likelihood Features&quot;，他对High Cardinal Categorical的特征用了一些额外的条件概率来计算其似然值，如p(y|manager_id, bathrooms)等，并且进行了点积操作来计算出一个合适的encoding值（类似于先前讨论区中出现的manager_skills，同时为了防止过拟合对这些似然估计出来的feature创建了2层嵌套。另外还有一种对我启发比较大的feature是对description出现频率最高的15k单词进行一个one-hot深度xgboost训练，将这个训练出来模型的预测结果作为description的encoding。</p></li>
<li>Top #3 <a href="https://www.kaggle.com/c/two-sigma-connect-rental-listing-inquiries/discussion/32123">solution</a> @Little Boat
<p> &emsp;&emsp;其FE的第一部分给出了group的一套方案，类似于我自己FE中的group方法。第二部分使用了magic feature相关的feature，方法与第一部分类似</p></li>
<li><p>Top #9 <a href="https://www.kaggle.com/c/two-sigma-connect-rental-listing-inquiries/discussion/32146">solution</a> @James Trotman
<p> &emsp;&emsp;没有细说，但是列出了一个feature name的详单，希望以后没有idea的时候能从中找到一些insight</p></p></li>
<li><p>Top #11 <a href="https://www.kaggle.com/c/two-sigma-connect-rental-listing-inquiries/discussion/32116">solution</a> @KazAnova
<p> &emsp;&emsp;KazAnova无疑是这场比赛中的明星选手，他分享了对初学者模型融合比较关键的StackNet，以及对最后榜单变动起到决定性作用的magic feature。几乎所有在榜上的Kagglers都要向他致敬。同时在FE这一块，他注意到了数据集中存在很多类似的数据（仅仅在价格上有区别），因此他建立了不同的group，并在这些group间创建了很多aggregated features，比如最高的price，平均price等</p></p></li>
<li><p>Top #12 <a href="https://www.kaggle.com/c/two-sigma-connect-rental-listing-inquiries/discussion/32118">solution</a> @b.e.s
<p> &emsp;&emsp;用到了基于高势集类别数据的group的一些统计量</p></p></li>
<li><p>Top #13 <a href="https://www.kaggle.com/c/two-sigma-connect-rental-listing-inquiries/discussion/32156">solution</a> @qianqian
<p> &emsp;&emsp;也是用了很多基于manager_id group的统计feature</p></p></li>
</ul>

<h3><h2 id="6"> 模型调参（Grid Search） </h2></h3>

<p>&emsp;&emsp;模型调参的话，能够在FE完之后为你提升0.001～0.002分数，因此如何为我们的分类器，比如xgboost选择好正确的参数是非常关键的。
 </p>

<p>&emsp;&emsp;比较常用的是进行Grid Search，从你的输入组合中暴力地搜索cv结果最优的组合。我一般会设定一个learning rate，然后尝试不同的参数组合，取最优值，因为训search的代价比较高，最好选择一定范围，比如你事先cv的时候知道estimater会在700～1000的范围内，那就不要search这个范围以外的值了。</p>

<h3><h2 id="7"> 模型融合 </h2></h3>

<p>&emsp;&emsp;如果你没有idea了的话，就模型融合吧！模型融合是能够快速提高比赛成绩的捷径，现在的比赛几乎没有人不用到这个技巧，通常获胜者会对很多很多模型进行融合，并且会选择不同的模型融合的方式。这里有一篇非常好的模型融合解析
<a href="https://mlwave.com/kaggle-ensembling-guide/">博文</a>
,相信每个看过它的人都会对模型融合有一个清楚的了解
<p>&emsp;&emsp;本次比赛中我使用了两种模型融合方式，一种是Averaging，一种是Stacking。</p>
<p>&emsp;&emsp;先来说说Stacking，因为这场比赛一名贡献比较大的选手分享了一个叫StackNet的库，作为新手我就直接用了。首先我用我的xgboost cv集交叉预测出结果作为feature的一部分放到train data中，再对test data进行预测的结果作为feature的一部分放到test data中，再在第二层上选择了Logistic Classifer，GradientBoostingClassifer，AdaBoostClassifer，NNSoftemaxClassfier，RandomForestClassifer等进行交叉预测，第三层选取了一个randomForest作为最后的结果训练和预测。Stacking主要增多了模型的diversity，使我的成绩上升了至少0.003的量级，</p>
<p>&emsp;&emsp;然后是Averaging，之前提到过Stacking需要交叉预测，我就选取了10组随机种子分别对训练集进行10-kfold交叉预测取平均，以及每个flod训练预测的时候我都对我的xgboost选取5个随机种子取平均。也就是说，在第一层Stacking的CV集交叉预测时我总共训练了500个模型进行平均。分数的提升大约在0.002左右。</p>
<p>&emsp;&emsp;直到比赛结束看了排名靠前的选手的模型融合后，才发现自己对于模型融合只是做了一点微小的工作，提升空间还非常大。详情可以看FE部分分享的solution链接。</p></p>

<h3><h2 id="8"> Tricks </h2></h3>

<p>&emsp;&emsp;在这场比赛中有一名在一开始的两个月一直遥遥领先的选手爆出这个比赛有个magic feature，大家陷入了疯狂找这个feature的过程中，直到那位分享了StackNet的选手分享出了这个magic feature：80G图片数据每个文件夹的创建时间，于是榜单大变，我一觉醒来后发现自己掉了很多就发现到了不对劲，便迅速加入到这个magic feature疯狂屠榜的大军中，从这里可以看见，一个信息量巨大的feature如果被发现的话，对比赛成绩会带来多么大的影响。</p>

<p></p>

<p>&emsp;&emsp;有一些group的feature能够起到非常重要的作用，详细见我比赛后发表的一个小样例
<a href="https://www.kaggle.com/c/two-sigma-connect-rental-listing-inquiries/discussion/32098#177847">discussion topic</a>
。但是一定要防止过拟合。</p></p>

<h3><h2 id="9"> 总结 </h2></h3>

<p>&emsp;&emsp;这篇博文还有一些关键的点没有涉及到，比如数据的清洗，有些数据在记录中似乎是不同的，但是意思是一样的，就应该归位同一个类别，还有就是清除一些outlier等。
<p>&emsp;&emsp;对这个比赛的top solution总结得还是没到位，基本没有coding实现他们的idea过。由于课程压力比较大，等到时候空了的时候再好好整理。</p>
<p>&emsp;&emsp;另外还有就是需要持之以恒地打这个比赛，因为你以为你idea都没有了，模型调参、融合完毕了的时候，可能大家都找出了另一个&quot;magic feature&quot;，轻松地把你挤出奖牌的范围内了。。</p>
<p>&emsp;&emsp;最后，Kaggle is fun!</p>
<p> 
<p>
<p>
<p></p>

<p><a rel="license" href="http://creativecommons.org/licenses/by-nc-nd/3.0/cn/"><img alt="知识共享许可协议" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-nd/3.0/cn/88x31.png" /></a><br />本博文采用<a rel="license" href="http://creativecommons.org/licenses/by-nc-nd/3.0/cn/">知识共享署名-非商业性使用-禁止演绎 3.0 中国大陆许可协议</a>进行许可</p>

  </div><!-- /.entry-content -->
</article><!-- /.hentry -->

<article class="hentry">
  <header>
    
    <div class="entry-meta">
      <span class="entry-date date published updated"><time datetime="2016-10-04T00:00:00+00:00"><a href="/pr-bayes-decision-rule/">October 04, 2016</a></time></span><span class="author vcard"><span class="fn"><a href="/about/" title="About Haojie PAN">Haojie PAN</a></span></span>
      
      <span class="entry-reading-time">
        <i class="fa fa-clock-o"></i>
        
Reading time ~2 minutes
      </span><!-- /.entry-reading-time -->
      
    </div><!-- /.entry-meta -->
    
      <h1 class="entry-title"><a href="/pr-bayes-decision-rule/" rel="bookmark" title="Bayes Decision Rule" itemprop="url">Bayes Decision Rule</a></h1>
    
  </header>
  <div class="entry-content">
    <blockquote>
<p>情景引入： 作为一个classificaton的问题，假设有sea bass 和 salmon两类鱼，而我们决策的目的是为了区分它们，用于区分我们将引入feature这个概念，大致意思就是可以用一系列特征来判断出某一条打捞上来的鱼是sea bass还是salmon，在这里我们只取一条鱼的lightness作为feature。</p>
</blockquote>

<h3>&emsp;目录</h3>

<ul>
<li><a href="#1">1. 相关术语</a></li>
<li><a href="#2">2. 似然值和似然函数</a></li>
<li><a href="#3">3. MLE 和 MAP</a></li>
<li><a href="#4">4. 贝叶斯公式</a></li>
<li><a href="#5">5. The Decision rules and loss function</a></li>
<li><a href="#6">6. The Risk</a></li>
<li><a href="#7">7. Bayes Decision Theory</a></li>
<li><a href="#8">8. 实战题以及代码</a></li>
</ul>

<p>&emsp;&emsp;</p>

<h3><h2 id="1"> 1. 相关术语 </h2></h3>

<ul>
<li>state of nature:
<p>&emsp;&emsp;在这个例子的前提下，我们可以断定自然状态下只有两种可能：sea bass和salmon. 如果我们用符号\( w \)来表示state of nature, 则\( w = w_1 \)为sea bass, \( w = w_2 \)为salmon</p></li>
<li>priori probability(<strong>prior</strong>):
<p>&emsp;&emsp;\( P(w_1) \)指打捞上来的下一条鱼为sea bass, \( P(w_2) \)指打捞上来的下一条鱼为salmon，很显然, \( P(w_1) + P(w_2) = 1 \). 从上述陈述中我们可以将prior理解为我们事先知道的知识，比如我们知道我们要打捞的海域这两种鱼的比例为2:1。</li>
<li>class-conditional probability density(<strong>likelihood</strong>):
<p>&emsp;&emsp;\( P(x \space | w_j) \), 用概率论的知识我们可以这么理解它：假设feature \( x \)在\( w_j \)这一类中服从某种分布，那么在这一类鱼的lightness为某一直的概率越大，相应的\( P(x \space | w_j) \)也就越大，比如说sea bass 的lightness 为10的可能性非常高，则\( P(x=10 \space | w_1) \)也就非常大。</li>
<li>evidence：
<p>&emsp;&emsp;\( p(x) \)， 在这个例子中表示的就是某个lightness在打捞上来的鱼中出现的概率有多高。同事我们也可以将其当做一个scale因子，这可以保证posterior概率之和为1.</li>
<li>posterior：
<p>&emsp;&emsp;\( P(w_j \space | x) \)， 在这个例子上即为当捞上一条鱼他的lightness为某一值时，它为sea bass和salmon的概率各自有多大
<p>&emsp;&emsp;</li>
</ul>

<h3><h2 id="2"> 2. 似然值(likelihood)和似然函数(<a href="https://en.wikipedia.org/wiki/Likelihood_function">likelihood funciton</a>) </h2></h3>

<p>&emsp;&emsp;我们假设likelihood:\( p(x \space | w_j) \)遵循某种涉及到参数\( \theta \)的分布（比如关于\( (\mu, \sigma^2) \)的正态分布, 则likelihood就相当于参数确定的给定分布下\( x \)发生的概率。
<p>&emsp;&emsp;从而似然函数即为对于\(\space data \space x \in X, state \space w \in W \)的一个条件概率分布\( p(x \space | w) \space \)
<p>&emsp;&emsp;</p>

<h3><h2 id="3"> 3.1 [附]Maximum likelihood Estimator(MLE) </h2></h3>

<p>&emsp;&emsp;在捞到的一堆鱼里面，统计得出对于sea bass鱼中\( lightness = x \) 出现的概率为 \( p_1 \), 对于salmon鱼中\( lightness = x \) 出现的概率为\( p_2 \)，假如\( p_1 \ge  p_2 \)，则我们可以粗浅的认为这条鱼是sea bass的可能性大一点，极端点想如果这个\( x \)在sea bass中出现频率最高，而在salmon中几乎不出现，肯定没有理由将其归为salmon了。用数学化的表示如下：
$$ w(x) = argmax_w(p(x \space | w))　$$
<p>&emsp;&emsp;特别的，对于二元问题我们经一系列不等式变换，再套个log函数可以列出下面的式子：
$$ log\frac{p(x \space | w_0)}{p(x \space | w_1)} &gt; 0 则 w(x) = w_0, 否则w(x) = w_１ $$
<p>&emsp;&emsp;我们将不等式右边log里的比值称作 <em>likelihood ratio</em>，这在下面的贝叶斯决策中也会涉及到。</p>

<p><p>&emsp;&emsp;</p>

<h3>3.2. [附]The Maximum A Posteriori Estimator(MAP)</h3>

<p>&emsp;&emsp;与上面的ML类似, MAP不过就是把最大化的概率换成了posterior的, 如下公式：
$$ w(x) = argmax_w(p(w \space | x))　$$</p>

<h3><h2 id="4"> 4. 贝叶斯公式 </h2></h3>

<p>&emsp;&emsp;学过概率论的同学应该对下面这个式子并不陌生：&emsp;\( P(w_j  | x) = \frac{p(x \space | w_j) P(w_j)}{p(x)} \)。&emsp;
有了上面的术语解释，我们可以用相关的术语来表达这个式子:
<center> \[ posterior = \frac{likelihood \times prior}{evidence} \]</center>
这就是所谓的贝叶斯公式了。
<p>&emsp;&emsp;我们知道，概率论中贝叶斯公式的推导是从下面这个等式中来的:
<center> \[ P(w_j  | x)p(x) = p(x \space | w_j) P(w_j) \] </center>
我们可以左右求和一下
<center> \[ \sum P(w_j  | x)p(x) = \sum p(x \space | w_j) P(w_j) \] </center>
而　\( \sum P(w_j  | x) = 1\)，所以有
<center> \[ p(x) = \sum p(x \space | w_j) P(w_j) \] </center>
因此贝叶斯公式又可以写成：
<center> \[ P(w_j  | x) = \frac{p(x \space | w_j) P(w_j)}{\sum p(x \space | w_j) P(w_j)} \] </center>
<p>&emsp;&emsp;</p>

<h3><h2 id="5"> 5. The Decision rules and loss function </h2></h3>

<p>&emsp;&emsp;假设我们捞上来一条鱼，通过上面陈述的一些方法，你将会判断它是sea bass还是salmon, 但是如果决策发生了错误怎么办？你会受到一定的损失(loss/cost), 这时候我们需要引进一个损失函数来判断这个决策到底会带来多大的损失，这就是loss function.
<p>&emsp;&emsp;在讲loss function前，我们先来引进一些符号，我们用\( \alpha(.) \)来表示一个　<em>decision rule</em>。
<p>&emsp;&emsp;如果我们进行了一个决策\( \alpha(x) \), 得到的结果是\(w \)，我们定义loss function 为\( \lambda(\alpha(x),w)　\)。
<p>&emsp;&emsp;</p>

<h3><h2 id="6"> 6. The Risk </h2></h3>

<p>&emsp;&emsp; 假设我们观察到了一个\( x \)，通过相应的决策我们得到了\( \alpha(x) = w_i \), 将这个决策记为\( \alpha_i \)。再假设我们要分的总类数为c，那么它的state of nature为\( w_j \)的可能性以posterior的方式表达就是: \( p(w_j \space | x) \)。
<p>&emsp;&emsp;有了上述的假设，我们就可以自然地定义采取决策\( \alpha_i \)所会造成的风险(Risk)为
$$ R(\alpha_i | x) = \sum_{j=1}^c \lambda(\alpha_i \space | w_j)P(w_j|x) $$</p>

<h3><h2 id="7"> 7. Bayes Decision Theory </h2></h3>

<p>&emsp;&emsp; 通过以上所说的我们就可以定义贝叶斯决策理论了: 即寻找一个决策\( \hat(\alpha) \)来使得Risk　\( R(\alpha) \)最小。即:
$$ \hat\alpha = arg_{\alpha \in A}min(R(\alpha)), \alpha \in A $$
<p>&emsp;&emsp;　\( \hat\alpha  \)被称作贝叶斯决策(<em>Bayes Decision</em>), \( R(\hat\alpha) \)被称作贝叶斯风险(<em>Bayes Risk</em>)</p>

<h3><h2 id="8"> 8. 实战以及代码 </h2></h3>

<p>&emsp;&emsp;在这里我们要尝试解决<a href="http://dengcai.zjulearning.org/Courses/DM/assignment/hw1/hw1.pdf">assignment 1</a>中关于Bayes Decision Rule 中的(b)题，　我的python代码及相关结果：<a href="https://github.com/ScarletPan/Open-class-HW/tree/master/DM-dengcai/HM1/bayes_decision_rule">链接</a></p>

  </div><!-- /.entry-content -->
</article><!-- /.hentry -->

<article class="hentry">
  <header>
    
    <div class="entry-meta">
      <span class="entry-date date published updated"><time datetime="2016-10-03T00:00:00+00:00"><a href="/pr-introduction/">October 03, 2016</a></time></span><span class="author vcard"><span class="fn"><a href="/about/" title="About Haojie PAN">Haojie PAN</a></span></span>
      
      <span class="entry-reading-time">
        <i class="fa fa-clock-o"></i>
        
Reading time ~1 minute
      </span><!-- /.entry-reading-time -->
      
    </div><!-- /.entry-meta -->
    
      <h1 class="entry-title"><a href="/pr-introduction/" rel="bookmark" title="导言" itemprop="url">导言</a></h1>
    
  </header>
  <div class="entry-content">
    <p><p>&emsp;&emsp; 到了大三了，<a href="https://github.com/ScarletPan/VisualQA">VQA</a>项目暂时没有新的进展，因此告一段落。与<a href="http://dengcai.zjulearning.org/">professor Cai</a> 交流后，听从他的建议将基础知识一步步地再搭建起来，对我以后将会有很大的帮助。回顾之前的学习生涯，在ML基础知识上花的其实挺少的，上过Andrew Ng在coursera上开的Machine learning课后似乎就直接开始学习NLP的相关知识了，再接着就是学习深度学习啊，学习RNN, LSTM之类的（虽然没有写博文），一开始professor Cai叫我看的 <em>Pattern Classification</em>  一书开了个头就没有继续看下去了。突然之间感觉自己的基础还不怎么扎实就想着飞了，可能对于自己以后的学习会造成影响，因此打算从头开始学ML的算法，重新开始看 <em>Pattern Classification</em> ，并且借助professor Cai的<a href="http://dengcai.zjulearning.org/Courses/DM/">课程网站</a>继续学习。
<p>&emsp;&emsp;理想中是每学习一块内容就同步一篇博文归纳，希望自己能好好坚持下去。</p>

  </div><!-- /.entry-content -->
</article><!-- /.hentry -->

<article class="hentry">
  <header>
    
    <div class="entry-meta">
      <span class="entry-date date published updated"><time datetime="2016-09-03T00:00:00+00:00"><a href="/tensorflow/">September 03, 2016</a></time></span><span class="author vcard"><span class="fn"><a href="/about/" title="About Haojie PAN">Haojie PAN</a></span></span>
      
      <span class="entry-reading-time">
        <i class="fa fa-clock-o"></i>
        
Reading time ~1 minute
      </span><!-- /.entry-reading-time -->
      
    </div><!-- /.entry-meta -->
    
      <h1 class="entry-title"><a href="/tensorflow/" rel="bookmark" title="极简的深度学习环境搭建(Nvidia GTX850 + cuda8.0 + tensorflow0.10.0 + ubuntu 16.04)" itemprop="url">极简的深度学习环境搭建(Nvidia GTX850 + cuda8.0 + tensorflow0.10.0 + ubuntu 16.04)</a></h1>
    
  </header>
  <div class="entry-content">
    <h2>1 &emsp; Linux 版本</h2>

<p><center><img src="http://o6qr23o6z.bkt.clouddn.com/post_16-09-03-1.png" alt="pic1"></center></p>

<h2>2 &emsp; GPU 信息</h2>

<p><center><img src="http://o6qr23o6z.bkt.clouddn.com/post_16-09-03-2.png" alt="pic2"></center></p>

<h2>3 &emsp; 安装nvidia驱动</h2>

<p>在software &amp; update中直接更改即可, 由于cuda对驱动版本要求高, 因此最好选择361．安装完后重启一下
<center><img src="http://o6qr23o6z.bkt.clouddn.com/post_16-09-03-3.png" alt="pic3"></center></p>

<h2>4 &emsp; 安装cuda 8.0</h2>

<ul>
<li>前往 <a href="https://developer.nvidia.com/cuda-release-candidate-download">cuda下载页面</a></li>
<li>注册（如果还没有账号）</li>
<li>选择deb下载
<center><img src="http://o6qr23o6z.bkt.clouddn.com/post_16-09-03-4.png" alt="pic4"></center></li>
<li>下载成功后在本地解包安装</li>
</ul>
<div class="highlight"><pre><code class="language-linux" data-lang="linux">$ sudo dpkg -i cuda-repo-ubuntu1604-8-0-rc_8.0.27-1_amd64.deb
$ sudo apt-get update
$ sudo apt-get install cuda
</code></pre></div>
<ul>
<li>设置环境变量
<p>在.bashrc中输入下列语句：</p></li>
</ul>
<div class="highlight"><pre><code class="language-" data-lang="">export LD_LIBRARY_PATH="$LD_LIBRARY_PATH:/usr/local/cuda/lib64:/usr/local/cuda/extras/CUPTI/lib64"
export CUDA_HOME=/usr/local/cuda
</code></pre></div>
<ul>
<li>测试(以1_Utilities/deviceQuery为例)：</li>
</ul>
<div class="highlight"><pre><code class="language-" data-lang="">$ cd /usr/local/cuda/samples/1_Utilities/deviceQuery
$ make
$ ./deviceQuery
</code></pre></div>
<p>&emsp;成功后大概长这样：
<center><img src="http://o6qr23o6z.bkt.clouddn.com/post_16-09-03-5.png" alt="pic5"></center></p>

<p><strong>UPDATE</strong> </p>

<ul>
<li>装了cuda 8运行pip下载的tensorflow会出现问题。如果读者出现问题，可以考虑安装7.5</li>
<li>cuda7.5并没有支持ubuntu16.04。但可以参考这个<a href="https://www.pugetsystems.com/labs/hpc/NVIDIA-CUDA-with-Ubuntu-16-04-beta-on-a-laptop-if-you-just-cannot-wait-775/">博文</a></li>
</ul>

<h2>5 &emsp; 部署cudnn4.0</h2>

<ol>
<li>前往　<a href="https://developer.nvidia.com/cudnn">cudnn下载页面</a></li>
<li>下载相应版本的cudnn4</li>
<li>将相应内容拷贝到cuda目录中</li>
</ol>
<div class="highlight"><pre><code class="language-" data-lang="">tar xvzf cudnn-7.5-linux-x64-v4.tgz
sudo cp cuda/include/cudnn.h /usr/local/cuda/include
sudo cp cuda/lib64/libcudnn* /usr/local/cuda/lib64
sudo chmod a+r /usr/local/cuda/include/cudnn.h /usr/local/cuda/lib64/libcudnn*
</code></pre></div>
<h2>6 &emsp; 安装相应的tensorflow</h2>

<p>前往 <a href="https://www.tensorflow.org/versions/r0.10/get_started/os_setup.html">tensorflow官网</a>，其中列举了不少安装方式，安装带gpu的版本</p>

<h2>7 &emsp; 测试</h2>

<p>可以用tensorflow自带的sample测试,可以看到gpu相对与cpu测试速度有很大的提升：
<p> cpu版本 </p>
<center><img src="http://o6qr23o6z.bkt.clouddn.com/post_16-09-03-6.png" alt="pic6"></center>
<p> gpu版本 </p>
<center><img src="http://o6qr23o6z.bkt.clouddn.com/post_16-09-03-7.png" alt="pic7"></center></p>

  </div><!-- /.entry-content -->
</article><!-- /.hentry -->

<article class="hentry">
  <header>
    
    <div class="entry-meta">
      <span class="entry-date date published updated"><time datetime="2016-08-24T00:00:00+00:00"><a href="/django/">August 24, 2016</a></time></span><span class="author vcard"><span class="fn"><a href="/about/" title="About Haojie PAN">Haojie PAN</a></span></span>
      
      <span class="entry-reading-time">
        <i class="fa fa-clock-o"></i>
        
Reading time ~2 minutes
      </span><!-- /.entry-reading-time -->
      
    </div><!-- /.entry-meta -->
    
      <h1 class="entry-title"><a href="/django/" rel="bookmark" title="Steps for starting a django app" itemprop="url">Steps for starting a django app</a></h1>
    
  </header>
  <div class="entry-content">
    <h3>Tips1: &emsp; 配置 pymysql　*</h3>

<p>在　<strong>init</strong>.py 中添加：</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">pymysql</span>
<span class="n">pymysql</span><span class="o">.</span><span class="n">install_as_MySQLdb</span><span class="p">()</span>
</code></pre></div>
<p>在　setting.py中修改：</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">DATABASES</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">'default'</span><span class="p">:</span> <span class="p">{</span>
        <span class="s">'ENGINE'</span><span class="p">:</span> <span class="s">'django.db.backends.mysql'</span><span class="p">,</span>
        <span class="s">'NAME'</span><span class="p">:</span> <span class="s">'vqa'</span><span class="p">,</span>  <span class="c"># mysql数据库名</span>
        <span class="s">'USER'</span><span class="p">:</span><span class="s">'root'</span><span class="p">,</span>  <span class="c">#　mysql用户名，留空则默认为当前linux用户名　</span>
        <span class="s">'PASSWORD'</span><span class="p">:</span><span class="s">'123456'</span><span class="p">,</span>
        <span class="s">'HOST'</span><span class="p">:</span><span class="s">''</span><span class="p">,</span>     <span class="c"># 留空默认为localhost</span>
        <span class="s">'PORT'</span><span class="p">:</span><span class="s">''</span><span class="p">,</span>     <span class="c"># 留空默认为3306端口</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h3>Tips2: &emsp; 创建数据库并且migrate</h3>

<p>在 mysql  中创建数据库
在项目目录中输入</p>
<div class="highlight"><pre><code class="language-" data-lang="">$ python manage.py migrate
</code></pre></div>
<p>成功后会看到：</p>
<div class="highlight"><pre><code class="language-" data-lang="">Operations to perform:
  Apply all migrations: auth, sessions, admin, contenttypes
Running migrations:
  Rendering model states... DONE
  Applying contenttypes.0001_initial... OK
  Applying auth.0001_initial... OK
  Applying admin.0001_initial... OK
  Applying admin.0002_logentry_remove_auto_add... OK
  Applying contenttypes.0002_remove_content_type_name... OK
  Applying auth.0002_alter_permission_name_max_length... OK
  Applying auth.0003_alter_user_email_max_length... OK
  Applying auth.0004_alter_user_username_opts... OK
  Applying auth.0005_alter_user_last_login_null... OK
  Applying auth.0006_require_contenttypes_0002... OK
  Applying auth.0007_alter_validators_add_error_messages... OK
  Applying sessions.0001_initial... OK

</code></pre></div>
<h3>Tips3: &emsp; 创建app</h3>

<p>在项目目录中输入</p>
<div class="highlight"><pre><code class="language-" data-lang="">$ python manage.py startapp polls
</code></pre></div>
<h3>Tips4: &emsp; 创建模型</h3>

<p>编辑　app/models.py</p>

<h3>Tips5: &emsp; 激活模型</h3>

<p>编辑　project/settings/py</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">INSTALLED_APPS</span> <span class="o">=</span> <span class="p">(</span>
    <span class="s">'django.contrib.admin'</span><span class="p">,</span>
    <span class="s">'django.contrib.auth'</span><span class="p">,</span>
    <span class="s">'django.contrib.contenttypes'</span><span class="p">,</span>
    <span class="s">'django.contrib.sessions'</span><span class="p">,</span>
    <span class="s">'django.contrib.messages'</span><span class="p">,</span>
    <span class="s">'django.contrib.staticfiles'</span><span class="p">,</span>
    <span class="s">'app'</span><span class="p">,</span>    <span class="c"># 这是新增的app</span>
<span class="p">)</span>
</code></pre></div>
<p>运行命令</p>
<div class="highlight"><pre><code class="language-" data-lang="">$ python manage.py makemigrations app    # app迁移
$ python manage.py sqlmigrate vqa 0001　 # sql迁移
$ python manage.py migrate # 将这些改变更新到数据库中。
</code></pre></div>
<h3>Tips5(+): &emsp; 修改模型</h3>
<div class="highlight"><pre><code class="language-" data-lang="">$ 修改models.py （最好每个类中都写上 def __str__())
$ python manage.py makemigrations
$ python manage.py migrate
</code></pre></div>
<h3>Tips6: &emsp; 创建管理网站</h3>
<div class="highlight"><pre><code class="language-" data-lang="">$ python manage.py createsuperuser # 创建一个能够登录管理站点的用户
</code></pre></div>
<p>在admin.py中注册，添加</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">django.contrib</span> <span class="kn">import</span> <span class="n">admin</span>

<span class="kn">from</span> <span class="nn">.models</span> <span class="kn">import</span> <span class="n">xxx</span>

<span class="n">admin</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">xxx</span><span class="p">)</span>
</code></pre></div>
<h3>Tips7: &emsp; 制作对外view</h3>

<ul>
<li>html 模板
在app中创建 app/templates/app/xxx.html</li>
<li>css,js, images 模板,</li>
<li>在app中创建 app/static/css/xxx.css</li>
<li>在project/setting.py 找到 STATIC_URL 并在下方添加</li>
</ul>
<div class="highlight"><pre><code class="language-" data-lang="">STATIC_ROOT = os.path.join(os.path.dirname(__file__),'static')
STATICFILES_DIRS = (
    ('css',os.path.join(STATIC_ROOT,'css').replace('\\','/') ), 
    ('js',os.path.join(STATIC_ROOT,'js').replace('\\','/') ),
    ('images',os.path.join(STATIC_ROOT,'images').replace('\\','/') ),
)
</code></pre></div>
<p>并创建相应的文件。
3. 相应的html中的link改为：</p>
<div class="highlight"><pre><code class="language-html" data-lang="html">    <span class="nt">&lt;link</span> <span class="na">type=</span><span class="s">"text/css"</span> <span class="na">rel=</span><span class="s">"stylesheet"</span> <span class="na">href=</span><span class="s">"/static/css/xxx.css"</span> <span class="nt">/&gt;</span>
</code></pre></div>
<h3>Tips8: &emsp; 部署项目</h3>

<p>详见：http://djangobook.py3k.cn/2.0/chapter12/</p>

<h3>*ImageField 的使用</h3>

<ol>
<li>在setting.py中添加路径和url:</li>
</ol>
<div class="highlight"><pre><code class="language-" data-lang="">MEDIA_ROOT = BASE_DIR + 'xxx/media/'
MEDIA_URL =  BASE_URL + 'xxx/media/'   # 两者其实相同
</code></pre></div>
<ol>
<li>在project/urls.py添加 url:</li>
</ol>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">django.conf.urls.static</span> <span class="kn">import</span> <span class="n">static</span>
<span class="kn">from</span> <span class="nn">django.conf</span> <span class="kn">import</span> <span class="n">settings</span>
<span class="o">***</span>
<span class="n">urlpatterns</span> <span class="o">+=</span> <span class="n">static</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">MEDIA_URL</span><span class="p">,</span> <span class="n">document_root</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">MEDIA_ROOT</span><span class="p">)</span>
</code></pre></div>
<ol>
<li>在app/model.py中对于相应的model:</li>
</ol>
<div class="highlight"><pre><code class="language-" data-lang="">xxx = models.ImageField(upload_to = '***') # ***为相对路径
</code></pre></div>
<h3>*配置ajax</h3>

<p>在js脚本前添加配置：</p>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">function</span> <span class="nx">getCookie</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">cookieValue</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">cookie</span> <span class="o">&amp;&amp;</span> <span class="nb">document</span><span class="p">.</span><span class="nx">cookie</span> <span class="o">!=</span> <span class="s1">''</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">cookies</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">cookie</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">';'</span><span class="p">);</span>
        <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">cookies</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">cookie</span> <span class="o">=</span> <span class="nx">jQuery</span><span class="p">.</span><span class="nx">trim</span><span class="p">(</span><span class="nx">cookies</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
            <span class="c1">// Does this cookie string begin with the name we want?</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">cookie</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">name</span><span class="p">.</span><span class="nx">length</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="nx">name</span> <span class="o">+</span> <span class="s1">'='</span><span class="p">))</span> <span class="p">{</span>
                <span class="nx">cookieValue</span> <span class="o">=</span> <span class="nb">decodeURIComponent</span><span class="p">(</span><span class="nx">cookie</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="nx">name</span><span class="p">.</span><span class="nx">length</span> <span class="o">+</span> <span class="mi">1</span><span class="p">));</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">cookieValue</span><span class="p">;</span>
<span class="p">}</span>
<span class="kd">var</span> <span class="nx">csrftoken</span> <span class="o">=</span> <span class="nx">getCookie</span><span class="p">(</span><span class="s1">'csrftoken'</span><span class="p">);</span>
<span class="kd">function</span> <span class="nx">csrfSafeMethod</span><span class="p">(</span><span class="nx">method</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// these HTTP methods do not require CSRF protection</span>
    <span class="k">return</span> <span class="p">(</span><span class="sr">/^</span><span class="se">(</span><span class="sr">GET|HEAD|OPTIONS|TRACE</span><span class="se">)</span><span class="sr">$/</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">method</span><span class="p">));</span>
<span class="p">}</span>
<span class="kd">function</span> <span class="nx">sameOrigin</span><span class="p">(</span><span class="nx">url</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// test that a given url is a same-origin URL</span>
    <span class="c1">// url could be relative or scheme relative or absolute</span>
    <span class="kd">var</span> <span class="nx">host</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">host</span><span class="p">;</span> <span class="c1">// host + port</span>
    <span class="kd">var</span> <span class="nx">protocol</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">protocol</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">sr_origin</span> <span class="o">=</span> <span class="s1">'//'</span> <span class="o">+</span> <span class="nx">host</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">origin</span> <span class="o">=</span> <span class="nx">protocol</span> <span class="o">+</span> <span class="nx">sr_origin</span><span class="p">;</span>
    <span class="c1">// Allow absolute or scheme relative URLs to same origin</span>
    <span class="k">return</span> <span class="p">(</span><span class="nx">url</span> <span class="o">==</span> <span class="nx">origin</span> <span class="o">||</span> <span class="nx">url</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">origin</span><span class="p">.</span><span class="nx">length</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="nx">origin</span> <span class="o">+</span> <span class="s1">'/'</span><span class="p">)</span> <span class="o">||</span>
        <span class="p">(</span><span class="nx">url</span> <span class="o">==</span> <span class="nx">sr_origin</span> <span class="o">||</span> <span class="nx">url</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">sr_origin</span><span class="p">.</span><span class="nx">length</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="nx">sr_origin</span> <span class="o">+</span> <span class="s1">'/'</span><span class="p">)</span> <span class="o">||</span>
        <span class="c1">// or any other URL that isn't scheme relative or absolute i.e relative.</span>
        <span class="o">!</span><span class="p">(</span><span class="sr">/^</span><span class="se">(\/\/</span><span class="sr">|http:|https:</span><span class="se">)</span><span class="sr">.*/</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">url</span><span class="p">));</span>
<span class="p">}</span>
<span class="nx">$</span><span class="p">.</span><span class="nx">ajaxSetup</span><span class="p">({</span>
    <span class="na">beforeSend</span><span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">xhr</span><span class="p">,</span> <span class="nx">settings</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">csrfSafeMethod</span><span class="p">(</span><span class="nx">settings</span><span class="p">.</span><span class="nx">type</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">sameOrigin</span><span class="p">(</span><span class="nx">settings</span><span class="p">.</span><span class="nx">url</span><span class="p">))</span> <span class="p">{</span>
            <span class="c1">// Send the token to same-origin, relative URLs only.</span>
            <span class="c1">// Send the token only if the method warrants CSRF protection</span>
            <span class="c1">// Using the CSRFToken value acquired earlier</span>
            <span class="nx">xhr</span><span class="p">.</span><span class="nx">setRequestHeader</span><span class="p">(</span><span class="s2">"X-CSRFToken"</span><span class="p">,</span> <span class="nx">csrftoken</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">});</span>
</code></pre></div>
  </div><!-- /.entry-content -->
</article><!-- /.hentry -->



<div class="pagination">
  <ul class="inline-list">
    
    

    
    
      <li><strong class="current-page">1</strong></li>
    

    
    

    
    
    

    

    
    

    
      <li><a href="/page2/">2</a></li>
    

    
    
      <li><a href="/page2/" class="btn">Next</a></li>
    
  </ul>
</div>

</div><!-- /#main -->

<div class="footer-wrapper">
  <footer role="contentinfo">
    <span>&copy; 2017 Haojie PAN. Powered by <a href="http://jekyllrb.com" rel="nofollow">Jekyll</a> using the <a href="https://mademistakes.com/work/hpstr-jekyll-theme/" rel="nofollow">HPSTR Theme</a>.</span>
  </footer>
</div><!-- /.footer-wrapper -->

<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script>window.jQuery || document.write('<script src="/assets/js/vendor/jquery-1.9.1.min.js"><\/script>')</script>
<script src="/assets/js/scripts.min.js"></script>




<script type="text/javascript"
        src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
</body>
</html>
